{% extends 'main/base.html' %}

{% block content %}
<div class="container">
    <h2>ðŸ”— Connect Telegram</h2>

    <div id="connectionStatus">
        {% if user.is_telegram_connected %}
            <div class="alert alert-success">
                <p>âœ… Telegram connected as @{{ user.telegram_username }}</p>
                <button onclick="disconnectTelegram()" class="btn btn-warning">Disconnect</button>
            </div>
        {% else %}
            <div class="alert alert-info">
                <p>Connect Telegram to receive notifications</p>
                <button onclick="connectTelegram()" class="btn btn-primary">Connect Telegram</button>
            </div>
        {% endif %}
    </div>

    <div id="telegramLink" style="display: none; margin-top: 20px;">
        <div class="alert alert-success">
            <p>Click the link below to connect your Telegram:</p>
            <a id="telegramUrl" href="#" target="_blank" class="btn btn-success">Open Telegram</a>
            <button onclick="copyLink()" class="btn btn-secondary">Copy Link</button>
        </div>
    </div>
</div>

<script>
function connectTelegram() {
    fetch('/telegram/connect/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑÑ‹Ð»ÐºÑƒ
            document.getElementById('telegramUrl').href = data.telegram_url;
            document.getElementById('telegramLink').style.display = 'block';

            // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Telegram (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
            window.open(data.telegram_url, '_blank');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to generate connection link');
    });
}

function copyLink() {
    const link = document.getElementById('telegramUrl').href;
    navigator.clipboard.writeText(link).then(() => {
        alert('Link copied to clipboard!');
    });
}

function disconnectTelegram() {
    if (confirm('Are you sure you want to disconnect Telegram?')) {
        alert('Disconnect functionality to be implemented');
    }
}
</script>
{% endblock %}